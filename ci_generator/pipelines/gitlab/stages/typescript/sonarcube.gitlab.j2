code_quality:
  stage: code_quality
  image: node:{{ ctx.node_version | default('18') }}
  dependencies:
    - test
    - lint
  script:
    - npm ci || yarn install --frozen-lockfile || true
    - npx sonar-scanner \
        -Dsonar.projectKey=${CI_PROJECT_NAME} \
        -Dsonar.sources=./src \
        -Dsonar.host.url=${SONAR_HOST_URL} \
        -Dsonar.login=${SONAR_TOKEN} \
        -Dsonar.typescript.lcov.reportPaths=coverage/lcov.info \
        -Dsonar.eslint.reportPaths=eslint-report.json || true
  only:
    - merge_requests
    - main
    - develop

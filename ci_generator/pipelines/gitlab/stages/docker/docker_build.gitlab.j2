{% set dockerfile_paths = ctx.dockerfile_paths or (ctx.dockerfile_path and [ctx.dockerfile_path] or []) %}
{% set is_single_dockerfile = dockerfile_paths|length == 1 %}
{% set single_dockerfile_in_root = is_single_dockerfile and (dockerfile_paths[0] == "Dockerfile" or "/" not in dockerfile_paths[0]) %}
{% if dockerfile_paths|length > 0 and not single_dockerfile_in_root %}
{# –ù–µ—Å–∫–æ–ª—å–∫–æ Dockerfile - –æ–¥–Ω–∞ –¥–∂–æ–±–∞ build_and_push –¥–ª—è –≤—Å–µ—Ö #}
build_and_push:
  stage: docker_build
  image: docker:24
  services:
    - name: docker:24-dind
      alias: docker
      command: ["--tls=false", "--host=tcp://0.0.0.0:2375"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
{% if ctx.language in ['go', 'golang'] %}
  dependencies:
    - build
{% endif %}
  before_script:
    - |
      echo "Waiting for Docker daemon to be ready..."
      timeout 30 sh -c 'until docker info; do sleep 1; done' || true
    - docker info
    - echo "Checking GitLab CI variables..."
    - echo "Logging to GitLab Container Registry with CI_JOB_TOKEN..."
    - echo "$CI_JOB_TOKEN" | docker login -u "gitlab-ci-token" "$CI_REGISTRY" --password-stdin
{% if ctx.language in ['go', 'golang'] %}
    # –î–ª—è Go –ø—Ä–æ–µ–∫—Ç–æ–≤: –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ Docker
    - |
      echo "Pre-building Go binaries (if needed)..."
      if [ -f "go.mod" ] || [ -f "Gopkg.toml" ] || [ -f "glide.yaml" ]; then
        echo "Go project detected, attempting to build binaries using Docker..."
        GO_VERSION="{{ ctx.go_version | default('1.21') }}"
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º Docker –¥–ª—è —Å–±–æ—Ä–∫–∏ –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤
        docker run --rm -v "$PWD:/src" -w /src golang:${GO_VERSION} sh -c "
          go mod download || true
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Makefile –∏ –ø—ã—Ç–∞–µ–º—Å—è —Å–æ–±—Ä–∞—Ç—å —á–µ—Ä–µ–∑ make
          if [ -f 'Makefile' ]; then
            echo 'Found Makefile, trying to build...'
            make build || make binary || make || true
          fi
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ build.go
          if [ -f 'build.go' ]; then
            echo 'Found build.go, running it...'
            go run build.go build || go run build.go || true
          fi
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ —Å–±–æ—Ä–∫–∏
          if [ -f 'scripts/build.sh' ] || [ -f 'build.sh' ]; then
            echo 'Found build script, running it...'
            chmod +x scripts/build.sh build.sh 2>/dev/null || true
            ./scripts/build.sh || ./build.sh || true
          fi
          # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏ —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ main –ø–∞–∫–µ—Ç—ã
          find . -name 'main.go' -type f | head -20 | while read main_file; do
            dir=\$(dirname \"\$main_file\")
            bin_name=\$(basename \"\$dir\")
            echo \"Attempting to build binary: \$bin_name\"
            (cd \"\$dir\" && go build -o \"../\${bin_name}-linux-amd64\" .) || true
          done
          # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –ø–∞–∫–µ—Ç–æ–≤
          go build ./... || true
        " || echo "‚ö†Ô∏è  Pre-build step failed, continuing with Docker builds..."
      fi
{% endif %}
  script:
    - echo "Building and pushing Docker images..."
{% for dockerfile_path in dockerfile_paths %}
{% set dockerfile_dir = dockerfile_path.rsplit('/', 1)[0] if '/' in dockerfile_path else '.' %}
{% set dockerfile_name = dockerfile_path.rsplit('/', 1)[-1] %}
{% if dockerfile_dir != '.' %}
{% set service_name_raw = dockerfile_dir.split('/')[-1] %}
{% elif dockerfile_name != 'Dockerfile' %}
{% set service_name_raw = dockerfile_name.replace('Dockerfile.', '').replace('Dockerfile-', '').replace('Dockerfile_', '') %}
{% else %}
{% set service_name_raw = 'main' %}
{% endif %}
{% set service_name = service_name_raw | lower | replace('.', '_') | replace('-', '_') %}
{% set service_name_display = service_name_raw | replace('-', ' ') | replace('_', ' ') | replace('.', ' ') | title %}
    
    # {{ service_name_display }}
    - |
      echo "Building {{ service_name_display }} ({{ dockerfile_path }})..."
      if docker build -f {{ dockerfile_path }} -t $CI_REGISTRY_IMAGE-{{ service_name }}:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE-{{ service_name }}:latest {{ dockerfile_dir | default(".", true) }}; then
        echo "Pushing {{ service_name_display }}..."
        docker push $CI_REGISTRY_IMAGE-{{ service_name }}:$CI_COMMIT_SHORT_SHA || echo "‚ö†Ô∏è  Failed to push $CI_COMMIT_SHORT_SHA tag"
        docker push $CI_REGISTRY_IMAGE-{{ service_name }}:latest || echo "‚ö†Ô∏è  Failed to push latest tag"
        echo "‚úÖ {{ service_name_display }} built and pushed successfully"
      else
        echo "‚ö†Ô∏è  Failed to build {{ service_name_display }}, continuing with next..."
      fi
{% endfor %}
    
    - echo "üéâ Build and push process completed!"
  after_script:
    - docker logout $CI_REGISTRY || true
{% else %}
{# –û–¥–∏–Ω Dockerfile –≤ –∫–æ—Ä–Ω–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ #}
docker_build:
  stage: docker_build
  image: docker:24
  services:
    - name: docker:24-dind
      alias: docker
      command: ["--tls=false", "--host=tcp://0.0.0.0:2375"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
{% if ctx.language in ['go', 'golang'] %}
  dependencies:
    - build
{% endif %}
  before_script:
    - |
      echo "Waiting for Docker daemon to be ready..."
      timeout 30 sh -c 'until docker info; do sleep 1; done' || true
  script:
    - docker build -f {{ ctx.dockerfile_path | default("Dockerfile") }} -t $DOCKER_IMAGE:$DOCKER_TAG {{ ctx.docker_context | default(".", true) }}
    - docker save -o image.tar $DOCKER_IMAGE:$DOCKER_TAG || true
  artifacts:
    paths:
      - image.tar
{% endif %}

lint:
  stage: lint
  image: {% if ctx.build_tool == 'maven' %}maven:3.9-eclipse-temurin-{{ ctx.java_version }}{% else %}gradle:8.5-jdk{{ ctx.java_version }}{% endif %}

  script:
    {% if ctx.build_tool == 'maven' %}
    - |
      # Находим директорию с pom.xml
      if [ -f "pom.xml" ]; then
        mvn checkstyle:check -Dcheckstyle.failOnViolation=false || true
        mvn spotbugs:check -Dspotbugs.failOnError=false || true
      else
        # Ищем pom.xml в поддиректориях
        POM_DIR=$(find . -name "pom.xml" -type f | head -1 | xargs dirname)
        if [ -n "$POM_DIR" ]; then
          cd "$POM_DIR"
          mvn checkstyle:check -Dcheckstyle.failOnViolation=false || true
          mvn spotbugs:check -Dspotbugs.failOnError=false || true
        else
          echo "POM file not found, skipping lint"
        fi
      fi
    {% elif ctx.build_tool == 'gradle' %}
    - |
      if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
        ./gradlew checkstyleMain --continue || true
        ./gradlew spotbugsMain --continue || true
      else
        GRADLE_DIR=$(find . -name "build.gradle*" -type f | head -1 | xargs dirname)
        if [ -n "$GRADLE_DIR" ]; then
          cd "$GRADLE_DIR"
          ./gradlew checkstyleMain --continue || true
          ./gradlew spotbugsMain --continue || true
        else
          echo "Gradle build file not found, skipping lint"
        fi
      fi
    {% endif %}
  artifacts:
    paths:
      {% if ctx.build_tool == 'maven' %}
      - target/spotbugsXml.xml
      {% elif ctx.build_tool == 'gradle' %}
      - build/reports/
      {% else %}
      - target/spotbugsXml.xml
      - build/reports/
      {% endif %}
    when: always
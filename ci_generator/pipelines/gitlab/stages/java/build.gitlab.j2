build:
  stage: build
  image: {% if ctx.build_tool == 'maven' %}maven:3.9-eclipse-temurin-{{ ctx.java_version }}{% else %}gradle:8.5-jdk{{ ctx.java_version }}{% endif %}

  script:
    {% if ctx.build_tool == 'maven' %}
    - |
      # Находим директорию с pom.xml
      if [ -f "pom.xml" ]; then
        mvn clean package -DskipTests
      else
        # Ищем pom.xml в поддиректориях
        POM_DIR=$(find . -name "pom.xml" -type f | head -1 | xargs dirname)
        if [ -n "$POM_DIR" ]; then
          cd "$POM_DIR"
          mvn clean package -DskipTests
        else
          echo "POM file not found"
          exit 1
        fi
      fi
    {% elif ctx.build_tool == 'gradle' %}
    - |
      if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
        ./gradlew build -x test
      else
        GRADLE_DIR=$(find . -name "build.gradle*" -type f | head -1 | xargs dirname)
        if [ -n "$GRADLE_DIR" ]; then
          cd "$GRADLE_DIR"
          ./gradlew build -x test
        else
          echo "Gradle build file not found"
          exit 1
        fi
      fi
    {% endif %}
  artifacts:
    paths:
      {% if ctx.build_tool == 'maven' %}
      - 'target/*.jar'
      {% elif ctx.build_tool == 'gradle' %}
      - 'build/libs/*.jar'
      {% else %}
      - 'target/*.jar'
      - 'build/libs/*.jar'
      {% endif %}
    expire_in: 1 week
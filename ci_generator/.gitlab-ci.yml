# Generated GitLab CI (auto)
stages:
  - test
  - docker_build
  - docker_push
  - migration

# Triggers (from user_settings.triggers)
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE == "push"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "prod" && $CI_PIPELINE_SOURCE == "push"'
      when: on_success

    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success



    - when: manual

# Common variables
variables:
  PYTHON_VERSION: "3.11"
  DOCKER_IMAGE: "registry.example.com/team/myapp"
  DOCKER_TAG: "v1.0.0"

  # Required CI/CD variables for this pipeline (configure in GitLab settings)
  # CI_REGISTRY: GitLab container registry URL (usually predefined)
  # CI_REGISTRY_USER: registry username for docker login
  # CI_REGISTRY_PASSWORD: registry password/token for docker login
  # KUBECONFIG_CONTENT: base64-encoded kubeconfig for Kubernetes deploy

# User variables (inlined - prefer CI platform variables for secrets)
  CI_VAR: "value"

test:
  stage: test
  image: python:3.11
  script:
    - pip install -r requirements.txt || true

    - pip install pytest pytest-cov || true
    - pytest --junitxml=test-results.xml --cov=. || true
  artifacts:
    when: always
    reports:
      junit: test-results.xml
    paths:
      - reports/
      - .pytest_cache/



docker_build:
  stage: docker_build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  script:
    - docker build -f Dockerfile -t $DOCKER_IMAGE:$DOCKER_TAG .
    - docker save -o image.tar $DOCKER_IMAGE:$DOCKER_TAG || true
  artifacts:
    paths:
      - image.tar
docker_push:
  stage: docker_push
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" $CI_REGISTRY --password-stdin
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
migration:
  stage: migration
  image: python:3.11
  script:
    - pip install -r requirements.txt || true


    - pip install django || true
    - python manage.py migrate || true



# Generated GitLab CI (auto)
stages:
  - pre_checks
  - lint
  - type_check
  - security
  - test
  - docker_build
  - docker_push
  - migration
  - cleanup

# Triggers (from user_settings.triggers)
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'





# Common variables
variables:
  DOCKER_IMAGE: "$CI_REGISTRY_IMAGE"
  DOCKER_TAG: "$CI_COMMIT_SHORT_SHA"
  PYTHON_VERSION: "3.11"

  # Required CI/CD variables for this pipeline (configure in GitLab settings)
  # CI_REGISTRY: GitLab container registry URL (usually predefined)
  # CI_REGISTRY_USER: registry username for docker login
  # CI_REGISTRY_PASSWORD: registry password/token for docker login
  # KUBECONFIG_CONTENT: base64-encoded kubeconfig for Kubernetes deploy

# User variables (inlined - prefer CI platform variables for secrets)

pre_checks:
  stage: pre_checks
  image: python:3.11
  script:
    - python --version
    - pip --version
    - echo "Basic repo checks (lint config, presence of tests, dockerfile...)"

lint:
  stage: lint
  image: python:3.11
  before_script:
    - python -m pip install --upgrade pip
  script:
    - pip install ruff flake8 || true
    - ruff check . || true
    - flake8 . || true
  artifacts:
    when: on_success
    paths:
      - reports/
    expire_in: 1 week
type_check:
  stage: type_check
  image: python:3.11
  script:
    - pip install mypy || true
    - mypy . || true
security:
  stage: security
  image: python:3.11
  script:
    - pip install safety bandit || true
    - safety check --json || true
    - bandit -r . -f json -o bandit-report.json || true
  artifacts:
    paths:
      - bandit-report.json
    expire_in: 1 week

test:
  stage: test
  
  image: python:3.11
  
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cache/pip
  
  before_script:
    - export PIP_CACHE_DIR=".cache/pip"
    - python -m pip install --upgrade pip
  
  script:
    - pip install -r requirements.txt || pip install -r requirements-dev.txt || true
    - pip install pytest pytest-cov || true
    - pytest --junitxml=test-results.xml --cov=. --cov-report=xml --cov-report=html --cov-report=term || true
  
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  
  artifacts:
    when: always
    paths:
      - test-results.xml
      - coverage.xml
      - htmlcov/
      - .pytest_cache/
    reports:
      junit: test-results.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
docker_build:
  stage: docker_build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  script:
    - docker build -f Dockerfile -t $DOCKER_IMAGE:$DOCKER_TAG .
    - docker save -o image.tar $DOCKER_IMAGE:$DOCKER_TAG || true
  artifacts:
    paths:
      - image.tar

docker_push:
  stage: docker_push
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  dependencies:
    - docker_build
  script:
    - docker load -i image.tar || true
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" $CI_REGISTRY --password-stdin
    - docker push $DOCKER_IMAGE:$DOCKER_TAG

migration:
  stage: migration
  image: python:3.11
  script:
    - pip install -r requirements.txt || true
    - pip install alembic || true
    - alembic upgrade head || true

cleanup:
  stage: cleanup
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker system prune -f || true
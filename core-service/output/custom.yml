# Generated GitLab CI (auto)
stages:
  - lint
  - test

# Triggers (from user_settings.triggers)
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "develop" && $CI_PIPELINE_SOURCE == "push"'

    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'



    - when: manual

# Common variables
variables:
  DOCKER_IMAGE: "$CI_REGISTRY_IMAGE"
  DOCKER_TAG: "$CI_COMMIT_SHORT_SHA"
  JAVA_VERSION: "21"
  BUILD_TOOL: "maven"

  # Required CI/CD variables for this pipeline (configure in GitLab settings)
  # CI_REGISTRY: GitLab container registry URL (usually predefined)
  # CI_REGISTRY_USER: registry username for docker login
  # CI_REGISTRY_PASSWORD: registry password/token for docker login
  # KUBECONFIG_CONTENT: base64-encoded kubeconfig for Kubernetes deploy

# User variables (inlined - prefer CI platform variables for secrets)

lint:
  stage: lint
  image: maven:3.9-eclipse-temurin-21
  script:
    - |
      # Находим директорию с pom.xml
      if [ -f "pom.xml" ]; then
        mvn checkstyle:check -Dcheckstyle.failOnViolation=false || true
        mvn spotbugs:check -Dspotbugs.failOnError=false || true
      else
        # Ищем pom.xml в поддиректориях
        POM_DIR=$(find . -name "pom.xml" -type f | head -1 | xargs dirname)
        if [ -n "$POM_DIR" ]; then
          cd "$POM_DIR"
          mvn checkstyle:check -Dcheckstyle.failOnViolation=false || true
          mvn spotbugs:check -Dspotbugs.failOnError=false || true
        else
          echo "POM file not found, skipping lint"
        fi
      fi
  artifacts:
    paths:
      - target/spotbugsXml.xml
    when: always
test:
  stage: test
  
  image: maven:3.9-eclipse-temurin-21
  
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .m2/repository
  
  before_script:
    - export MAVEN_OPTS="-Dmaven.repo.local=${CI_PROJECT_DIR}/.m2/repository"
  
  script:
    - |
      # Находим директорию с pom.xml
      if [ -f "pom.xml" ]; then
        mvn test || true
        mvn jacoco:report || true
      else
        # Ищем pom.xml в поддиректориях
        POM_DIR=$(find . -name "pom.xml" -type f | head -1 | xargs dirname)
        if [ -n "$POM_DIR" ]; then
          cd "$POM_DIR"
          mvn test || true
          mvn jacoco:report || true
        else
          echo "POM file not found, skipping tests"
        fi
      fi
  
  coverage: '/Total.*?([0-9]{1,3})%/'
  
  artifacts:
    when: always
    paths:
      - target/site/jacoco/
      - target/surefire-reports/
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    expire_in: 1 week